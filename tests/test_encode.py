"""Test the module used for encoding."""
import pytest
import numpy as np

from src.backend import encode


@pytest.fixture()
def image_arr():
    """Return array of the test png file."""
    # TODO: Figure out how to read files in GitLab CI/CD
    return np.array(
        [
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 51, 255],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
        ],
        dtype=np.uint8,
    )


@pytest.mark.parametrize(
    "text",
    [
        "",
        "123",
        "abc",
        "1a*",
        "1 a",
        " 1a ",
        ".",
        "qwertyasdf...",
        "\\\\\\",
        "~!@#$%$^&*(*)+",
        "abc123/-*" * 500,
    ],
)
def test_str_into_bin_array(text):
    result = "".join(
        map(
            lambda char: format(char, "b").zfill(8),
            bytearray(text, encoding="utf-8"),
        )
    )

    arr = encode.str_into_bin_array(text)
    data = "".join(
        (format(i, "b").zfill(8)[-1] for i, _ in zip(arr.flatten(), range(len(result))))
    )

    assert data == result


@pytest.mark.parametrize(
    "text",
    [
        "",
        "123",
        "abc",
        "1a*",
        "1 a",
        " 1a ",
        ".",
        "qwertyasdf... ",
        "\\\\\\",
        "~!@#$%$^&*(*)+",
        "a4" * 30,
    ],
)
def test_encode_message(image_arr, text):
    new_arr = encode.encode_message(image_arr, text)
    extracted_text = ""
    for rgb_vals, _ in zip(new_arr.reshape(-1, 8), range(len(text))):
        binary = (bin(num)[-1] for num in rgb_vals)
        extracted_text += chr(int("".join(binary), base=2))

    assert text == extracted_text
